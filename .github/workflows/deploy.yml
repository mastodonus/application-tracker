name: Deploy Application Tracker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_PUBLIC_IP }} << EOF
            set -e

            APP_DIR=/home/ec2-user/application-tracker

            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/mastodonus/application-tracker.git $APP_DIR
            fi

            cd $APP_DIR

            cat > .env << ENVEOF
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          POSTGRES_DATABASE=${{ secrets.POSTGRES_DATABASE }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

          API_DOMAIN=${{ secrets.EC2_PUBLIC_IP }}
          API_PORT=${{ secrets.API_PORT }}
          API_JWT_SECRET=${{ secrets.API_JWT_SECRET }}
          API_COOKIE_MAX_AGE=${{ secrets.API_COOKIE_MAX_AGE }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}

          CLIENT_DOMAIN=${{ secrets.EC2_PUBLIC_IP }}
          CLIENT_PORT=${{ secrets.CLIENT_PORT }}
          ENVEOF

          chmod 600 .env
          chown ec2-user:ec2-user .env

            docker-compose up -d --build --force-recreate
          EOF